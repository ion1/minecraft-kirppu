# Dockerfile is generated from Dockerfile.liquid

FROM openjdk:16 AS minecraft-base
RUN \
  groupadd -g 1000 minecraft && \
  useradd -u 1000 -g minecraft -s /bin/sh minecraft && \
  mkdir -p /minecraft/server /minecraft/mods && \
  chown -R minecraft:minecraft /minecraft

FROM minecraft-base AS minecraft-download
RUN microdnf install wget && microdnf clean all
COPY download-mod /

FROM minecraft-download AS minecraft-server
USER minecraft
WORKDIR /minecraft/server
RUN wget -nc -O ../fabric-installer.jar {{ fabricInstallerURL | shell_escape }}
RUN \
  java -jar ../fabric-installer.jar server \
  -mcversion {{ minecraftVersion | shell_escape }} \
  -loaderversion {{ fabricLoaderVersion | shell_escape }} \
  -downloadMinecraft

{% for mod in mods -%}
FROM minecraft-download AS minecraft-mod-{{ mod.id | shell_escape }}
USER minecraft
WORKDIR /minecraft/mods
RUN /download-mod {{ mod.filename | shell_escape }}{% for url in mod.urls %} {{ url | shell_escape }}{% endfor %}

{% endfor -%}
FROM itzg/rcon-cli AS rcon-cli

FROM minecraft-base
VOLUME /data
RUN \
  mkdir -p /data && \
  chown -R minecraft:minecraft /data
USER minecraft
WORKDIR /data

COPY --from=minecraft-server /minecraft/server/*.jar /minecraft/server/
{% for mod in mods -%}
COPY --from=minecraft-mod-{{ mod.id | shell_escape }} /minecraft/mods/{{ mod.filename | shell_escape }} /minecraft/mods/
{% endfor -%}
COPY --from=rcon-cli /rcon-cli /
COPY rcon /
COPY log4j2.xml /minecraft/
COPY start health-check /
EXPOSE 25565
ENTRYPOINT ["/start"]
HEALTHCHECK --start-period=1m CMD ["/health-check"]
